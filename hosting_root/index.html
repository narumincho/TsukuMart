<!doctype html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>つくマート 読み込み中</title>
    <link rel="stylesheet" href="/style.css">
    <link rel="icon" href="/assets/logo_bird.png">
    <link rel="manifest" href="/manifest.json">
</head>

<body>
    <script src="/main.js"></script>
    <script>
        "use strict";
        /* Elmを起動!! */
        const app = Elm.Main.init({
            flags: {
                emailAddress: localStorage.getItem("emailAddress"),
                password: localStorage.getItem("password")
            }
        });
        const windowResizeListener = (e) => {
            if (1000 < innerWidth) {
                app.ports.toWideScreenMode.send(null);
            } else {
                app.ports.toNarrowScreenMode.send(null);
            }
        };
        /* ウィンドウサイズのリサイズ情報をElmに送信 */
        addEventListener("resize", windowResizeListener);
        windowResizeListener();
        /* メールアドレスとパスワードを保存する */
        app.ports.saveEmailAddressAndPasswordToLocalStorage.subscribe(({ emailAddress, password }) => {
            localStorage.setItem("emailAddress", emailAddress);
            localStorage.setItem("password", password);
        });
        /* メールアドレスとパスワードとその他すべてを削除する */
        app.ports.deleteEmailAddressAndPasswordFromLocalStorage.subscribe( () => {
            localStorage.clear();
        });
        /* 指定されたidの<input type="file">から1つファイルの情報を受け取りData URLに変換してElmに送信 */
        app.ports.studentImageChange.subscribe(id => {
            const fileInputElement = document.getElementById(id);
            const imageFile = fileInputElement.files[0]
            if (imageFile === undefined) {
                return;
            }
            const fileReader = new FileReader();
            fileReader.addEventListener("load", (e) => {
                app.ports.receiveImageDataUrl.send(fileReader.result)
            })
            fileReader.readAsDataURL(imageFile);
        });
        /* 指定されたidの<input type="file">から複数のファイルの情報を受け取りData URLに変換してElmに送信 */
        app.ports.exhibitionImageChange.subscribe(id => {
            const fileInputElement = document.getElementById(id);
            const result = [];
            for (const imageFile of fileInputElement.files) {
                result.push({
                    file: imageFile,
                    blobUrl: URL.createObjectURL(imageFile)
                });
            }
            app.ports.receiveImageFileAndBlobUrl.send(result);
        });
        /* 指定されたidの要素のテキストの内容を変える */
        app.ports.inputOrTextAreaReplaceText.subscribe(({ id, text }) => {
            requestAnimationFrame(() => {
                const element = document.getElementById(id);
                if (element !== null) {
                    element.value = text;
                }
            })
        });
        /* 指定されたidの要素のselectedIndexを変更する */
        app.ports.changeSelectedIndex.subscribe(({ id, index }) => {
            requestAnimationFrame(() => {
                const element = document.getElementById(id);
                if (element !== null) {
                    element.selectedIndex = index;
                }
            })
        });
        /* 指定されたidの要素が表示されるようにスクロールさせる */
        app.ports.elementScrollIntoView.subscribe(id => {
            requestAnimationFrame(() => {
                const element = document.getElementById(id);
                if (element !== null) {
                    element.scrollIntoView({ behavior: "smooth", block: "center" });
                }
            })
        });
        /* ファイルをドロップして追加 */
        app.ports.addEventListenerDrop.subscribe(id => {
            requestAnimationFrame(() => {
                const element = document.getElementById(id);
                if (element !== null) {
                    element.addEventListener("dragover", e => {
                        e.preventDefault();
                    })
                    element.addEventListener("drop", e => {
                        e.preventDefault();
                        const result = [];
                        for (const imageFile of e.dataTransfer.files) {
                            result.push({
                                file: imageFile,
                                blobUrl: URL.createObjectURL(imageFile)
                            });
                        }
                        app.ports.receiveImageFileAndBlobUrl.send(result);
                    })
                }
            })
        })

        navigator.serviceWorker.register("/serviceworker.js", { scope: "/" });
    </script>
</body>